<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a Interactiva y Asistente IA de Ecuaciones Diferenciales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- KaTeX for beautiful math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMeaOjwCLHsgoIBiKAwbBIeltQKb7eoFNOlfNLcdJdTEa9geb" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlVwcjNcsNQTeKaix6bYafGITIKlEgaEDRTkg6bA/0BlOdlvdLdQYJeMCYY" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax5AScKprqUXsoH41W5ZBVHutoQN/cxEq2I" crossorigin="anonymous"></script>

    <!-- Chart.js for stats -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: Se ha dise√±ado una aplicaci√≥n de una sola p√°gina con una navegaci√≥n superior basada en pesta√±as. Cada pesta√±a corresponde a un m√©todo de resoluci√≥n de EDOs de primer orden. Esta estructura de "dashboard" o "caja de herramientas" es ideal para una gu√≠a de estudio, ya que permite al usuario acceder directamente al tema de inter√©s sin necesidad de desplazarse por contenido irrelevante. El flujo es simple: el usuario selecciona un tipo de ecuaci√≥n y la aplicaci√≥n muestra instant√°neamente la informaci√≥n relevante (identificaci√≥n, m√©todo, f√≥rmulas). Se eligi√≥ este dise√±o por ser altamente funcional y estar orientado a la tarea principal del usuario: identificar y resolver un problema espec√≠fico r√°pidamente. -->
    <!-- Visualization & Content Choices: El contenido de la gu√≠a de estudio es procedimental y basado en f√≥rmulas, por lo que no se requieren gr√°ficos o tablas de datos. La informaci√≥n se presenta utilizando una jerarqu√≠a clara con encabezados, listas ordenadas para los pasos de resoluci√≥n y bloques de c√≥digo estilizados para resaltar las f√≥rmulas matem√°ticas. El objetivo es la claridad y la legibilidad. La interactividad principal es la navegaci√≥n por pesta√±as, que permite al usuario controlar qu√© contenido se muestra. Esta elecci√≥n de presentaci√≥n directa y estructurada con HTML/Tailwind es la m√°s efectiva para comunicar esta informaci√≥n t√©cnica. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .formula-block {
            font-family: 'Roboto Mono', monospace;
            background-color: #f1f5f9; /* slate-100 */
            border-left: 4px solid #14b8a6; /* teal-500 */
            padding: 1rem;
            border-radius: 0.25rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .nav-btn {
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .nav-btn.active {
            border-bottom-color: #14b8a6; /* teal-500 */
            color: #0f766e; /* teal-700 */
            font-weight: 600;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .gemini-btn {
            background-color: #0d9488; /* teal-600 */
            color: white;
            transition: background-color 0.2s;
            opacity: 1;
        }
        .gemini-btn:hover {
            background-color: #0f766e; /* teal-700 */
        }
        .gemini-btn:disabled {
            background-color: #a1a1aa; /* zinc-400 */
            cursor: not-allowed;
        }
        .secondary-btn {
            background-color: #475569; /* slate-600 */
        }
        .secondary-btn:hover {
            background-color: #334155; /* slate-700 */
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="min-h-screen container mx-auto px-4 py-8 md:py-12">
        
        <div id="api-key-alert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-md" role="alert">
          <p class="font-bold">Acci√≥n Requerida: Configura tu API Key de Gemini</p>
          <p>Para activar las funciones de IA, necesitas obtener una clave de API gratuita de Google AI Studio y pegarla en el c√≥digo de este archivo.</p>
        </div>
         <div id="firebase-config-alert" class="hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-8 rounded-md" role="alert">
          <p class="font-bold">Acci√≥n Requerida: Configura Firebase</p>
          <p>Para activar el inicio de sesi√≥n y las estad√≠sticas, necesitas crear un proyecto en Firebase y pegar la configuraci√≥n en el c√≥digo de este archivo.</p>
        </div>

        <header class="text-center mb-10 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Gu√≠a Interactiva y Asistente IA de Ecuaciones Diferenciales</h1>
            <p class="mt-2 text-lg text-slate-600">Una herramienta de estudio completa para resolver y verificar EDOs de primer orden.</p>
            
            <div id="profile-button-container" class="absolute top-0 right-0">
                <button id="profile-button" class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-300 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </button>
            </div>
        </header>

        <nav class="mb-8 border-b border-slate-200">
            <ul class="flex flex-wrap -mb-px justify-center text-sm font-medium text-center text-slate-500">
                 <li id="dashboard-nav-item" class="mr-2 hidden">
                    <button class="nav-btn inline-block p-4 rounded-t-lg font-bold text-violet-600" data-target="dashboard">Dashboard</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg font-bold text-teal-600" data-target="custom-equation">Tu Ecuaci√≥n</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="identificar-metodos">C√≥mo Identificar M√©todos</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="separables">Variables Separables</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="homogeneas">Homog√©neas</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="exactas">Exactas</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="lineales">Lineales</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="bernoulli">Bernoulli</button>
                </li>
                <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="coeficientes">Coef. Lineales</button>
                </li>
                 <li class="mr-2">
                    <button class="nav-btn inline-block p-4 rounded-t-lg" data-target="aplicaciones">Aplicaciones</button>
                </li>
            </ul>
        </nav>

        <main>
            <!-- Template for Method Sections -->
            <template id="method-template">
                <div class="border-t-2 border-slate-200 mt-8 pt-6">
                    <h3 class="text-xl font-semibold mb-3 text-slate-800">Asistente de Pr√°ctica IA</h3>
                    <p class="text-slate-600 mb-4">Genera un problema, intenta resolverlo y comprueba tu respuesta.</p>
                    <button class="gemini-btn gemini-example-btn font-bold py-2 px-4 rounded-lg inline-flex items-center">
                        <span class="mr-2">‚ú®</span> Generar Nuevo Problema
                    </button>
                    <div class="gemini-result-container mt-4 p-4 bg-slate-50 rounded-lg min-h-[80px]">
                        <!-- Gemini result will be injected here -->
                    </div>
                    
                    <div class="check-answer-block hidden mt-4">
                        <h4 class="font-semibold mb-2">Verifica tu Respuesta</h4>
                        <p class="text-sm text-slate-600 mb-2">Introduce tu soluci√≥n (ej: y = x^2 + C) y comprueba si es correcta.</p>
                        <div class="flex flex-col sm:flex-row gap-2">
                             <input type="text" class="user-answer-input flex-grow p-2 border border-slate-300 rounded-lg" placeholder="Escribe tu soluci√≥n aqu√≠...">
                             <button class="gemini-btn gemini-check-btn font-bold py-2 px-4 rounded-lg">Verificar</button>
                        </div>
                        <div class="gemini-check-result-container mt-2 p-3 rounded-lg"></div>
                    </div>

                    <div class="solution-block hidden mt-4">
                        <h4 class="font-semibold mb-2">¬øNecesitas ayuda?</h4>
                        <button class="gemini-btn gemini-solve-btn font-bold py-2 px-4 rounded-lg inline-flex items-center text-sm">
                           <span class="mr-2">üß†</span> Ver Procedimiento Completo
                        </button>
                        <div class="gemini-solve-result-container mt-4 p-4 border border-slate-200 rounded-lg min-h-[100px] hidden">
                           
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Admin Dashboard -->
            <section id="dashboard" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-violet-700">Panel de Administrador</h2>
                    <button id="logout-button" class="text-sm font-medium text-slate-600 hover:text-slate-800">Cerrar Sesi√≥n</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-50 p-4 rounded-lg"><h4 class="text-slate-500 text-sm font-medium">Visitas Totales</h4><p id="stats-total-visits" class="text-2xl font-bold">Cargando...</p></div>
                    <div class="bg-slate-50 p-4 rounded-lg"><h4 class="text-slate-500 text-sm font-medium">Tiempo Promedio (Segundos)</h4><p id="stats-avg-time" class="text-2xl font-bold">Cargando...</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div><h3 class="font-semibold mb-2">Visitas por D√≠a</h3><div class="chart-container h-64"><canvas id="visitsByDayChart"></canvas></div></div>
                    <div><h3 class="font-semibold mb-2">Visitas por Mes</h3><div class="chart-container h-64"><canvas id="visitsByMonthChart"></canvas></div></div>
                </div>

                <div id="user-management-section" class="hidden mt-8 pt-6 border-t border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Gesti√≥n de Usuarios</h3>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">A√±adir Nuevo Administrador</h4>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="email" id="new-admin-email" placeholder="Email del nuevo admin" class="flex-grow p-2 border border-slate-300 rounded-lg">
                            <button id="add-admin-button" class="gemini-btn font-bold py-2 px-4 rounded-lg">A√±adir</button>
                        </div>
                         <p id="add-admin-feedback" class="text-sm mt-2"></p>
                    </div>
                </div>
            </section>

            <!-- Custom Equation Solver -->
            <section id="custom-equation" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4 text-teal-700">Calculadora de Ecuaciones Diferenciales</h2>
                 <p class="mb-6 text-slate-600">Introduce tu ecuaci√≥n, obt√©n una recomendaci√≥n del m√©todo ideal y luego resu√©lvela paso a paso.</p>
                 
                 <div class="space-y-4">
                    <div>
                        <label for="custom-eq-input" class="block font-semibold mb-1">Tu Ecuaci√≥n Diferencial:</label>
                        <input type="text" id="custom-eq-input" placeholder="Ej: dy/dx = 2xy" class="w-full p-2 border border-slate-300 rounded-lg font-mono">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="analyze-custom-eq-btn" class="gemini-btn font-bold py-2 px-6 rounded-lg">Analizar y Recomendar</button>
                    </div>
                 </div>

                 <div id="custom-eq-recommendation-container" class="mt-6 pt-6 border-t border-slate-200 min-h-[80px]">
                    <!-- Recommendation will be injected here -->
                 </div>

                 <div id="custom-solver-block" class="hidden mt-6 pt-6 border-t border-slate-200">
                    <div>
                        <label for="custom-method-select" class="block font-semibold mb-1">M√©todo de Resoluci√≥n a Utilizar:</label>
                        <select id="custom-method-select" class="w-full p-2 border border-slate-300 rounded-lg bg-white">
                           <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <button id="solve-custom-eq-btn" class="gemini-btn secondary-btn font-bold py-2 px-6 rounded-lg mt-4">Resolver con M√©todo Seleccionado</button>
                     <div id="custom-eq-result-container" class="mt-4 min-h-[150px]">
                         <!-- Custom solution will be injected here -->
                     </div>
                 </div>
            </section>
            
            <!-- How to Identify Section -->
            <section id="identificar-metodos" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4 text-teal-700">C√≥mo Identificar el M√©todo Correcto</h2>
                 <p class="mb-6 text-slate-600">Aprender a clasificar una ecuaci√≥n es el primer y m√°s importante paso. Aqu√≠ tienes una gu√≠a r√°pida para reconocer las pistas clave en cada tipo de EDO.</p>
                 <div id="identification-guide-content" class="space-y-6">
                    <!-- Guide content will be injected here -->
                 </div>
            </section>

            <!-- Sections for methods -->
            <section id="separables" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            <section id="homogeneas" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            <section id="exactas" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            <section id="lineales" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            <section id="bernoulli" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            <section id="coeficientes" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md"></section>
            
            <!-- Aplicaciones -->
            <section id="aplicaciones" class="content-section bg-white p-6 md:p-8 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4 text-teal-700">Aplicaciones de Ecuaciones de 1er Orden</h2>
                 <p class="mb-6 text-slate-600">Las ecuaciones diferenciales son la base para modelar c√≥mo cambian los sistemas en el tiempo. Aqu√≠ hay algunos ejemplos cl√°sicos.</p>
                 <div class="space-y-8" id="applications-content">
                    <!-- Application content will be injected here by JS -->
                 </div>
                 <div class="border-t-2 border-slate-200 mt-8 pt-6">
                    <h3 class="text-xl font-semibold mb-3 text-slate-800">‚ú® Descubre Aplicaciones en tu Campo</h3>
                    <p class="text-slate-600 mb-4">Introduce un √°rea de estudio o industria (ej: "biolog√≠a", "finanzas", "ingenier√≠a aeroespacial") y la IA encontrar√° una aplicaci√≥n relevante.</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="app-query-input" placeholder="Ej: qu√≠mica, econom√≠a..." class="flex-grow p-2 border border-slate-300 rounded-lg">
                        <button id="gemini-app-btn" class="gemini-btn font-bold py-2 px-4 rounded-lg">Encontrar Aplicaci√≥n Real</button>
                    </div>
                    <div id="gemini-app-result-container" class="mt-4 p-4 bg-slate-50 rounded-lg min-h-[120px]">
                        <!-- Gemini app result will be injected here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="auth-modal-overlay" class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
        <div id="auth-modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md mx-auto p-6 relative transform scale-95">
            <button id="close-modal-button" class="absolute top-2 right-2 text-slate-500 hover:text-slate-800 text-3xl leading-none">&times;</button>
            
            <!-- Login View -->
            <div id="login-view">
                <h3 class="text-xl font-bold mb-4">Acceso de Administrador</h3>
                <div class="space-y-4">
                    <div><label for="login-email" class="block text-sm font-medium text-slate-700">Email</label><input type="email" id="login-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div>
                    <div><label for="login-password" class="block text-sm font-medium text-slate-700">Contrase√±a</label><input type="password" id="login-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div>
                    <p id="login-error" class="text-red-500 text-sm"></p>
                    <button id="login-button" class="w-full gemini-btn font-bold py-2 px-4 rounded-lg">Iniciar Sesi√≥n</button>
                </div>
                <p class="text-center text-sm mt-4">¬øNo tienes cuenta? <button id="show-register-view" class="font-medium text-teal-600 hover:text-teal-500">Reg√≠strate</button></p>
            </div>

            <!-- Register View -->
            <div id="register-view" class="hidden">
                 <h3 class="text-xl font-bold mb-4">Registro de Administrador</h3>
                 <p id="register-info" class="text-sm text-slate-600 mb-4"></p>
                <div class="space-y-4">
                    <div><label for="register-email" class="block text-sm font-medium text-slate-700">Email</label><input type="email" id="register-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div>
                    <div><label for="register-password" class="block text-sm font-medium text-slate-700">Contrase√±a</label><input type="password" id="register-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm"></div>
                    <p id="register-error" class="text-red-500 text-sm"></p>
                    <button id="register-button" class="w-full gemini-btn font-bold py-2 px-4 rounded-lg">Registrar</button>
                </div>
                <p class="text-center text-sm mt-4">¬øYa tienes cuenta? <button id="show-login-view" class="font-medium text-teal-600 hover:text-teal-500">Inicia Sesi√≥n</button></p>
            </div>
        </div>
    </div>


    <!-- Main App Script -->
    <script type="module">
        // --- ‚ö†Ô∏è CRITICAL FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAQwVCW_8l0fiNgdb7ZrgsIhFYRhnVDJoU",
          authDomain: "cetiestudiantes-51dbf.firebaseapp.com",
          projectId: "cetiestudiantes-51dbf",
          storageBucket: "cetiestudiantes-51dbf.appspot.com",
          messagingSenderId: "571802127445",
          appId: "1:571802127445:web:a07a7b60cbb520d7ec18dc",
          measurementId: "G-8J41RMPB6Q"
        };
        // ---------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Main App Logic ---
        const contentData = {
                separables: {
                    name: "Variables Separables",
                    title: "1. Ecuaciones de Variables Separables",
                    description: "Son el tipo m√°s sencillo. La estrategia es aislar cada variable a un lado de la ecuaci√≥n para poder integrar.",
                    content: `
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-xl font-semibold mb-2">Identificaci√≥n</h3>
                                <p class="mb-3">La ecuaci√≥n se puede reescribir algebraicamente en la siguiente forma:</p>
                                <div class="formula-block">$$ g(y) dy = f(x) dx $$</div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-2">M√©todo de Soluci√≥n</h3>
                                <p class="mb-3">Una vez separadas las variables, se integra cada lado de la ecuaci√≥n de forma independiente.</p>
                                <div class="formula-block">$$ \\int g(y) dy = \\int f(x) dx + C $$</div>
                            </div>
                        </div>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n diferencial de primer orden de variables separables en la forma g(y)dy = f(x)dx. Proporciona solo la ecuaci√≥n. Usa funciones comunes como polinomios, sin, cos o e^x. Usa delimitadores de $$ para la matem√°tica."
                },
                homogeneas: {
                    name: "Homog√©neas",
                    title: "2. Ecuaciones Homog√©neas",
                    description: "Estas ecuaciones se caracterizan porque todos sus t√©rminos tienen el mismo grado. Se resuelven con una sustituci√≥n que las convierte en ecuaciones de variables separables.",
                    content: `<h3 class="text-xl font-semibold mb-2">Identificaci√≥n</h3><p class="mb-3">La ecuaci√≥n se puede expresar en funci√≥n del cociente y/x:</p><div class="formula-block mb-6">$$ \\frac{dy}{dx} = F(\\frac{y}{x}) $$</div><h3 class="text-xl font-semibold mb-2">M√©todo de Soluci√≥n</h3><ol class="list-decimal list-inside space-y-4"><li><span class="font-semibold">Sustituci√≥n clave:</span> $$ v = y/x \\rightarrow y = vx $$</li><li><span class="font-semibold">Derivar y reemplazar:</span> $$ \\frac{dy}{dx} = v + x \\frac{dv}{dx} $$</li><li><span class="font-semibold">Resolver la nueva ecuaci√≥n</span> de variables separables.</li><li><span class="font-semibold">Revertir la sustituci√≥n:</span> Se reemplaza $$ v = y/x $$.</li></ol>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n diferencial homog√©nea de primer orden en la forma dy/dx = F(y/x). Proporciona solo la ecuaci√≥n. Aseg√∫rate de que F(y/x) sea una funci√≥n de la relaci√≥n y/x. Usa delimitadores de $$ para la matem√°tica."
                },
                 exactas: {
                    name: "Exactas",
                    title: "3. Ecuaciones Exactas",
                    description: `Provienen de la diferenciaci√≥n total de una funci√≥n F(x, y). La clave es verificar primero la "condici√≥n de exactitud".`,
                    content: `<h3 class="text-xl font-semibold mb-2">Identificaci√≥n</h3><div class="formula-block mb-6">$$ M(x, y) dx + N(x, y) dy = 0 $$</div><h3 class="text-xl font-semibold mb-2">Condici√≥n de Exactitud</h3><div class="formula-block mb-6">$$ \\frac{\\partial M}{\\partial y} = \\frac{\\partial N}{\\partial x} $$</div><h3 class="text-xl font-semibold mb-2">M√©todo de Soluci√≥n</h3><p class="mb-3">La soluci√≥n es $$ F(x, y) = C $$. Se encuentra integrando M respecto a x, derivando respecto a y, e igualando a N para hallar la funci√≥n constante g(y).</p>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n diferencial exacta de primer orden en la forma M(x, y)dx + N(x, y)dy = 0. Proporciona solo la ecuaci√≥n. Aseg√∫rate de que cumpla la condici√≥n de exactitud ‚àÇM/‚àÇy = ‚àÇN/‚àÇx. Usa delimitadores de $$ para la matem√°tica."
                },
                lineales: {
                    name: "Lineales",
                    title: "4. Ecuaciones Lineales",
                    description: `Estas ecuaciones tienen una estructura muy definida. Se resuelven con un "factor integrante" que las hace f√°cilmente integrables.`,
                    content: `<h3 class="text-xl font-semibold mb-2">Identificaci√≥n (Forma Est√°ndar)</h3><div class="formula-block mb-6">$$ \\frac{dy}{dx} + P(x)y = Q(x) $$</div><h3 class="text-xl font-semibold mb-2">M√©todo de Soluci√≥n</h3><ol class="list-decimal list-inside space-y-4"><li><span class="font-semibold">Calcular Factor Integrante ($$\\mu$$):</span><div class="formula-block mt-2">$$\\mu(x) = e^{\\int P(x)dx}$$</div></li><li><span class="font-semibold">Aplicar f√≥rmula de soluci√≥n:</span><div class="formula-block mt-2">$$ y \\cdot \\mu(x) = \\int Q(x) \\cdot \\mu(x) dx + C $$</div></li><li><span class="font-semibold">Despejar y.</span></li></ol>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n diferencial lineal de primer orden en la forma dy/dx + P(x)y = Q(x). Proporciona solo la ecuaci√≥n. Usa funciones P(x) y Q(x) que sean integrables. Usa delimitadores de $$ para la matem√°tica."
                },
                bernoulli: {
                    name: "de Bernoulli",
                    title: "5. Ecuaci√≥n de Bernoulli",
                    description: "Son ecuaciones no lineales que se parecen mucho a las lineales. Una sustituci√≥n inteligente las transforma en una ecuaci√≥n lineal que ya sabemos resolver.",
                    content: `<h3 class="text-xl font-semibold mb-2">Identificaci√≥n</h3><div class="formula-block mb-6">$$ \\frac{dy}{dx} + P(x)y = Q(x)y^n $$</div><h3 class="text-xl font-semibold mb-2">M√©todo de Soluci√≥n</h3><ol class="list-decimal list-inside space-y-4"><li><span class="font-semibold">Sustituci√≥n clave:</span><div class="formula-block mt-2">$$ v = y^{1-n} $$</div></li><li><span class="font-semibold">Transformar a ecuaci√≥n lineal:</span><div class="formula-block mt-2">$$ \\frac{dv}{dx} + (1-n)P(x)v = (1-n)Q(x) $$</div></li><li><span class="font-semibold">Resolver la ecuaci√≥n lineal para 'v'.</span></li><li><span class="font-semibold">Revertir la sustituci√≥n.</span></li></ol>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n de Bernoulli de primer orden en la forma dy/dx + P(x)y = Q(x)y^n, donde n no es 0 ni 1. Proporciona solo la ecuaci√≥n. Usa delimitadores de $$ para la matem√°tica."
                },
                coeficientes: {
                    name: "con Coeficientes Lineales",
                    title: "6. Ecuaciones con Coeficientes Lineales",
                    description: "La forma de esta ecuaci√≥n involucra dos l√≠neas rectas. El m√©todo de soluci√≥n depende de si estas l√≠neas se cruzan o son paralelas.",
                    content: `<h3 class="text-xl font-semibold mb-2">Identificaci√≥n</h3><div class="formula-block mb-6">$$ (a_1x + b_1y + c_1)dx + (a_2x + b_2y + c_2)dy = 0 $$</div><h3 class="text-xl font-semibold mb-2">An√°lisis de Casos</h3><p class="mb-4">Se debe calcular el determinante $$a_1b_2 - a_2b_1$$.</p><div class="grid md:grid-cols-2 gap-6"><div class="border border-slate-200 rounded-lg p-4"><h4 class="font-semibold text-lg mb-2">Caso 1: L√≠neas se cruzan ($$\\neq 0$$)</h4><p>Se usa la sustituci√≥n $$ x = u + h, y = v + k $$ para convertirla en una homog√©nea.</p></div><div class="border border-slate-200 rounded-lg p-4"><h4 class="font-semibold text-lg mb-2">Caso 2: L√≠neas paralelas ($$= 0$$)</h4><p>Se usa la sustituci√≥n $$ z = a_1x + b_1y $$ para convertirla en una de variables separables.</p></div></div>`,
                    prompt: "Genera un ejemplo de una ecuaci√≥n diferencial con coeficientes lineales en la forma (a1x + b1y + c1)dx + (a2x + b2y + c2)dy = 0. Proporciona solo la ecuaci√≥n. Usa delimitadores de $$ para la matem√°tica."
                }
            };

            const identificationGuideContent = `
                <div class="p-4 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-teal-700">1. Variables Separables</h3>
                    <p class="mt-1 mb-2 text-slate-600"><span class="font-semibold">La Pista Clave:</span> ¬øPuedes manipular algebraicamente la ecuaci√≥n para que todos los t√©rminos con 'y' y 'dy' queden de un lado y todos los t√©rminos con 'x' y 'dx' del otro?</p>
                    <div class="formula-block text-sm">Ejemplo: $$ (x^2+1) \\frac{dy}{dx} = y $$ es separable porque se puede reescribir como $$ \\frac{1}{y} dy = \\frac{1}{x^2+1} dx $$.</div>
                </div>
                 <div class="p-4 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-teal-700">2. Ecuaciones Lineales</h3>
                    <p class="mt-1 mb-2 text-slate-600"><span class="font-semibold">La Pista Clave:</span> ¬øTiene la estructura r√≠gida $$ \\frac{dy}{dx} + P(x)y = Q(x) $$? La variable 'y' y su derivada deben tener exponente 1.</p>
                    <div class="formula-block text-sm">Ejemplo: $$ \\frac{dy}{dx} + (2x)y = x^2 $$ es lineal. Aqu√≠, $$ P(x) = 2x $$ y $$ Q(x) = x^2 $$.</div>
                </div>
                 <div class="p-4 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-teal-700">3. Ecuaci√≥n de Bernoulli</h3>
                    <p class="mt-1 mb-2 text-slate-600"><span class="font-semibold">La Pista Clave:</span> Es casi lineal, pero tiene un t√©rmino $$y^n$$ extra multiplicando al lado derecho.</p>
                    <div class="formula-block text-sm">Ejemplo: $$ \\frac{dy}{dx} + \\frac{1}{x}y = x y^2 $$ es una ecuaci√≥n de Bernoulli con n=2. Si no estuviera el $$ y^2 $$, ser√≠a lineal.</div>
                </div>
                 <div class="p-4 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-teal-700">4. Ecuaciones Exactas</h3>
                    <p class="mt-1 mb-2 text-slate-600"><span class="font-semibold">La Pista Clave:</span> Viene en la forma $$ M(x, y)dx + N(x, y)dy = 0 $$. Si no es separable, lineal o de Bernoulli, el siguiente paso es probar la condici√≥n de exactitud: $$ \\frac{\\partial M}{\\partial y} = \\frac{\\partial N}{\\partial x} $$</p>
                    <div class="formula-block text-sm">Ejemplo: $$ (2xy)dx + (x^2 - 1)dy = 0 $$. Aqu√≠, $$ M = 2xy $$ y $$ N = x^2-1 $$. Como $$ \\frac{\\partial M}{\\partial y} = 2x $$ y $$ \\frac{\\partial N}{\\partial x} = 2x $$, es exacta.</div>
                </div>
                 <div class="p-4 border border-slate-200 rounded-lg">
                    <h3 class="font-bold text-lg text-teal-700">5. Ecuaciones Homog√©neas</h3>
                    <p class="mt-1 mb-2 text-slate-600"><span class="font-semibold">La Pista Clave:</span> Todos los t√©rminos tienen el mismo "grado" (la suma de los exponentes de x e y). O, equivalentemente, la ecuaci√≥n se puede reescribir como $$ \\frac{dy}{dx} = F(\\frac{y}{x}) $$.</p>
                    <div class="formula-block text-sm">Ejemplo: $$ (x^2 + y^2)dx + 2xy dy = 0 $$. Cada t√©rmino ($$x^2, y^2, 2xy$$) es de grado 2.</div>
                </div>
            `;
            document.getElementById('identification-guide-content').innerHTML = identificationGuideContent;


            // --- ‚ö†Ô∏è CRITICAL API KEY CONFIGURATION ---
            const apiKey = "AIzaSyCl3DHOrqxjQEptoFMttbVsRtiEFAoAlGU"; 
            // -----------------------------------------

            const mainContainer = document.querySelector('main');
            const template = document.getElementById('method-template');

            const customMethodSelect = document.getElementById('custom-method-select');
            Object.keys(contentData).forEach(key => {
                const section = document.getElementById(key);
                const data = contentData[key];
                
                if(section){
                    section.dataset.methodName = data.name;
                    let content = `
                        <h2 class="text-2xl font-bold mb-4 text-teal-700">${data.title}</h2>
                        <p class="mb-6 text-slate-600">${data.description}</p>
                        ${data.content}`;
                    
                    const geminiBlock = template.content.cloneNode(true);
                    geminiBlock.querySelector('.gemini-example-btn').dataset.prompt = data.prompt;
                    section.innerHTML = content;
                    section.appendChild(geminiBlock);
                }

                const option = document.createElement('option');
                option.value = data.name;
                option.textContent = data.title.split('. ')[1]; 
                customMethodSelect.appendChild(option);
            });
            
            const applicationsContent = document.getElementById('applications-content');
            applicationsContent.innerHTML = `
                <div><h3 class="text-xl font-semibold mb-2">Crecimiento y Decaimiento Exponencial</h3><p class="mb-3">Describe fen√≥menos donde la tasa de cambio de una cantidad es proporcional a la cantidad misma.</p><div class="formula-block mb-3">$$ \\frac{dy}{dt} = ky $$</div></div>
                <div><h3 class="text-xl font-semibold mb-2">Ley de Enfriamiento de Newton</h3><p class="mb-3">La tasa a la que un objeto cambia de temperatura es proporcional a la diferencia entre su temperatura y la del ambiente.</p><div class="formula-block mb-3">$$ \\frac{dT}{dt} = k(T - T_a) $$</div></div>
                <div><h3 class="text-xl font-semibold mb-2">Problemas de Mezclas</h3><p class="mb-3">Modelan la cantidad de una sustancia en un tanque donde un fluido entra y sale.</p><div class="formula-block mb-3">$$ \\frac{dA}{dt} = (\\text{tasa entrada}) - (\\text{tasa salida}) $$</div></div>
                <div><h3 class="text-xl font-semibold mb-2">Circuitos El√©ctricos RL en Serie</h3><p class="mb-3">Describe la corriente en un circuito simple con una resistencia, un inductor y una fuente de voltaje.</p><div class="formula-block mb-3">$$ L \\frac{dI}{dt} + RI = V(t) $$</div></div>`;
            
            const navButtons = document.querySelectorAll('.nav-btn');
            const contentSections = document.querySelectorAll('.content-section');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    contentSections.forEach(section => section.classList.toggle('active', section.id === targetId));
                });
            });
            
            function renderMath(container) {
                 if (window.renderMathInElement) {
                    window.renderMathInElement(container, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ]
                    });
                }
            }

            // --- App Initialization ---
            let sessionStartTime = Date.now();
            let visitsByDayChart, visitsByMonthChart;


            function mainApp() {
                // UI Setup
                document.querySelector('.nav-btn[data-target="custom-equation"]').click();
                renderMath(document.body);

                // Config Checks
                if (!apiKey) {
                    document.getElementById('api-key-alert').classList.remove('hidden');
                    document.querySelectorAll('.gemini-btn').forEach(btn => btn.disabled = true);
                }
                if (!app.options.apiKey || app.options.apiKey === "TU_API_KEY_DE_FIREBASE") {
                     document.getElementById('firebase-config-alert').classList.remove('hidden');
                     document.getElementById('profile-button').disabled = true;
                }
                
                // Analytics
                trackVisit();
                window.addEventListener('beforeunload', trackSessionDuration);

                // Auth
                onAuthStateChanged(auth, handleAuthStateChange);
            }

            // --- Analytics Logic ---
            async function trackVisit() {
                const analyticsRef = doc(db, "analytics", "main");
                try {
                    // This structure is not optimal for scaling.
                    // For a real app, use Cloud Functions to aggregate daily/monthly data.
                    const docSnap = await getDoc(analyticsRef);
                    if (docSnap.exists()) {
                        let timestamps = docSnap.data().visitTimestamps || [];
                        timestamps.push(new Date());
                        // Keep only the last N timestamps to avoid document size issues
                        if (timestamps.length > 500) {
                            timestamps = timestamps.slice(timestamps.length - 500);
                        }
                        await updateDoc(analyticsRef, {
                            totalVisits: increment(1),
                            visitTimestamps: timestamps
                        });
                    } else {
                         await setDoc(analyticsRef, { 
                            totalVisits: 1, 
                            totalSessionTime: 0, 
                            sessionCount: 0,
                            visitTimestamps: [new Date()]
                        });
                    }
                } catch (e) {
                     console.error("Error tracking visit:", e);
                }
            }
            
            async function trackSessionDuration() {
                const duration = Math.round((Date.now() - sessionStartTime) / 1000); // in seconds
                const analyticsRef = doc(db, "analytics/main");
                try {
                     await updateDoc(analyticsRef, {
                        totalSessionTime: increment(duration),
                        sessionCount: increment(1)
                    });
                } catch (e) {
                    console.error("Error tracking session duration:", e);
                }
            }


            // --- Auth UI and State Management ---
            const modal = document.getElementById('auth-modal');
            const modalOverlay = document.getElementById('auth-modal-overlay');
            const closeModalBtn = document.getElementById('close-modal-button');
            const profileBtn = document.getElementById('profile-button');
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');

            const showRegisterBtn = document.getElementById('show-register-view');
            const showLoginBtn = document.getElementById('show-login-view');

            profileBtn.addEventListener('click', () => modal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modalOverlay.addEventListener('click', () => modal.classList.add('hidden'));
            
            showRegisterBtn.addEventListener('click', async () => {
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
                
                const usersCol = collection(db, "users");
                const q = query(usersCol, where("role", "in", ["admin", "superAdmin"]));
                const querySnapshot = await getDocs(q);
                const registerInfo = document.getElementById('register-info');
                
                if (querySnapshot.empty) {
                    registerInfo.textContent = "¬°Bienvenido! Ser√°s el primer administrador (Super Admin) de la aplicaci√≥n.";
                    document.getElementById('register-button').disabled = false;
                } else {
                    registerInfo.textContent = "El registro est√° deshabilitado. Un Super Admin debe invitarte.";
                    document.getElementById('register-button').disabled = true;
                }
            });
            showLoginBtn.addEventListener('click', () => {
                registerView.classList.add('hidden');
                loginView.classList.remove('hidden');
            });


            async function handleAuthStateChange(user) {
                const dashboardNavItem = document.getElementById('dashboard-nav-item');
                const userManagementSection = document.getElementById('user-management-section');

                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists() && (userDoc.data().role === 'admin' || userDoc.data().role === 'superAdmin')) {
                        dashboardNavItem.classList.remove('hidden');
                        if(userDoc.data().role === 'superAdmin') {
                            userManagementSection.classList.remove('hidden');
                        }
                        modal.classList.add('hidden');
                        document.querySelector('.nav-btn[data-target="dashboard"]').click();
                        loadDashboardData();
                    } else {
                        await signOut(auth);
                    }
                } else {
                    dashboardNavItem.classList.add('hidden');
                    userManagementSection.classList.add('hidden');
                    if(document.querySelector('.nav-btn.active').getAttribute('data-target') === 'dashboard') {
                       document.querySelector('.nav-btn[data-target="custom-equation"]').click();
                    }
                }
            }


            // --- Auth Actions ---
            const loginBtn = document.getElementById('login-button');
            loginBtn.addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorP = document.getElementById('login-error');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    errorP.textContent = '';
                } catch (error) {
                    errorP.textContent = "Error: " + error.message;
                }
            });

            const registerBtn = document.getElementById('register-button');
            registerBtn.addEventListener('click', async () => {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorP = document.getElementById('register-error');
                 try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        role: 'superAdmin',
                        createdAt: serverTimestamp ? serverTimestamp() : new Date()
                    });
                    errorP.textContent = '';
                } catch (error) {
                    errorP.textContent = "Error: " + error.message;
                }
            });
            
            const logoutBtn = document.getElementById('logout-button');
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
            });

             const addAdminBtn = document.getElementById('add-admin-button');
             addAdminBtn.addEventListener('click', async () => {
                const email = document.getElementById('new-admin-email').value;
                const feedbackP = document.getElementById('add-admin-feedback');
                if(!email) {
                    feedbackP.textContent = 'Por favor, introduce un email.';
                    feedbackP.className = 'text-sm mt-2 text-red-500';
                    return;
                }
                feedbackP.textContent = 'Funcionalidad de invitaci√≥n simplificada. En una app real, esto enviar√≠a un email. Por ahora, el usuario debe registrarse con este email para ser admin (funcionalidad no implementada).';
                feedbackP.className = 'text-sm mt-2 text-orange-500';
             });

            // --- Dashboard Logic ---
            async function loadDashboardData() {
                const analyticsRef = doc(db, "analytics", "main");
                const analyticsSnap = await getDoc(analyticsRef);

                if (analyticsSnap.exists()) {
                    const data = analyticsSnap.data();
                    document.getElementById('stats-total-visits').textContent = data.totalVisits || 0;
                    const avgTime = (data.sessionCount > 0) ? (data.totalSessionTime / data.sessionCount).toFixed(1) : 0;
                    document.getElementById('stats-avg-time').textContent = avgTime;

                    const allTimestamps = data.visitTimestamps && Array.isArray(data.visitTimestamps) 
                        ? data.visitTimestamps.map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000)) 
                        : [];
                    
                    renderCharts(allTimestamps);
                }
            }

            function renderCharts(timestamps) {
                if (!timestamps || timestamps.length === 0) return;
                
                const dailyData = timestamps.reduce((acc, ts) => {
                    const day = new Date(ts.getFullYear(), ts.getMonth(), ts.getDate()).toISOString().split('T')[0];
                    acc[day] = (acc[day] || 0) + 1;
                    return acc;
                }, {});

                const monthlyData = timestamps.reduce((acc, ts) => {
                    const month = `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}`;
                    acc[month] = (acc[month] || 0) + 1;
                    return acc;
                }, {});

                const dailyLabels = Object.keys(dailyData).sort();
                const dailyCounts = dailyLabels.map(label => dailyData[label]);
                
                const monthlyLabels = Object.keys(monthlyData).sort();
                const monthlyCounts = monthlyLabels.map(label => monthlyData[label]);

                if (visitsByDayChart) visitsByDayChart.destroy();
                visitsByDayChart = new Chart(document.getElementById('visitsByDayChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: dailyLabels, datasets: [{ label: 'Visitas', data: dailyCounts, backgroundColor: 'rgba(20, 184, 166, 0.5)' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } } } }
                });

                if (visitsByMonthChart) visitsByMonthChart.destroy();
                visitsByMonthChart = new Chart(document.getElementById('visitsByMonthChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: monthlyLabels, datasets: [{ label: 'Visitas', data: monthlyCounts, borderColor: 'rgba(139, 92, 246, 1)', tension: 0.1 }] },
                     options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const model = "gemini-2.5-flash-preview-05-20";

            async function callGemini(prompt, useGrounding = false, retries = 3, delay = 1000) {
                if (!apiKey) {
                    throw new Error("API key is missing.");
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                if (useGrounding) {
                    payload.tools = [{ "google_search": {} }];
                }

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callGemini(prompt, useGrounding, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result;

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    throw error;
                }
            }
            
            function handleApiError(error, container) {
                if (error.message.includes('401') || error.message.includes('API key not valid')) {
                    container.innerHTML = `<p class="text-red-600 font-bold">Error 401: Clave de API no v√°lida o ausente. Aseg√∫rate de haberla pegado correctamente en la variable 'apiKey' del c√≥digo.</p>`;
                } else if (error.message.includes('403')) {
                     container.innerHTML = `<p class="text-red-600 font-bold">Error 403: Permiso denegado. Aseg√∫rate de haber habilitado la "Vertex AI API" en tu proyecto de Google Cloud.</p>`;
                } else if (error.message.includes('API key is missing')) {
                    container.innerHTML = `<p class="text-red-600 font-bold">Error: Falta la clave de API. Por favor, config√∫rala en el c√≥digo para usar las funciones de IA.</p>`;
                } else {
                    container.innerHTML = `<p class="text-red-600 font-bold">Ocurri√≥ un error al contactar la IA. Int√©ntalo de nuevo.</p>`;
                }
            }

            // --- Event Listeners for Practice Sections ---
            document.querySelectorAll('.gemini-example-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const btn = event.currentTarget;
                    const resultContainer = btn.nextElementSibling;
                    const checkBlock = resultContainer.nextElementSibling;
                    const solutionBlock = checkBlock.nextElementSibling;

                    checkBlock.classList.add('hidden');
                    solutionBlock.classList.add('hidden');
                    solutionBlock.querySelector('.gemini-solve-result-container').innerHTML = '';
                    solutionBlock.querySelector('.gemini-solve-result-container').classList.add('hidden');
                    resultContainer.dataset.problem = '';
                    resultContainer.innerHTML = '<div class="loader"></div>';
                    btn.disabled = true;

                    try {
                        const result = await callGemini(btn.dataset.prompt);
                        if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            const text = result.candidates[0].content.parts[0].text;
                            resultContainer.innerHTML = `<div class="font-semibold">${text.trim()}</div>`;
                            resultContainer.dataset.problem = text.trim();
                            renderMath(resultContainer);
                            checkBlock.classList.remove('hidden');
                            solutionBlock.classList.remove('hidden');
                        } else {
                            resultContainer.innerHTML = `<p class="text-red-500">La IA no devolvi√≥ un ejemplo. Int√©ntalo de nuevo.</p>`;
                        }
                    } catch (error) {
                        handleApiError(error, resultContainer);
                    } finally {
                        btn.disabled = false;
                    }
                });
            });

            document.querySelectorAll('.gemini-check-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const btn = event.currentTarget;
                    const resultContainer = btn.closest('.check-answer-block').querySelector('.gemini-check-result-container');
                    const userAnswer = btn.previousElementSibling.value.trim();
                    const problem = btn.closest('.content-section').querySelector('.gemini-result-container').dataset.problem;

                    if (!userAnswer) {
                        resultContainer.innerHTML = `<p class="text-orange-600 font-semibold">Por favor, introduce tu respuesta.</p>`;
                        return;
                    }

                    resultContainer.innerHTML = '<div class="loader" style="margin: 0 auto;"></div>';
                    btn.disabled = true;

                    const checkPrompt = `La ecuaci√≥n diferencial es: ${problem}. Un usuario ha propuesto la siguiente soluci√≥n: ${userAnswer}. ¬øEs esta soluci√≥n correcta? Responde 'Correcto.' o 'Incorrecto.' en la primera l√≠nea. Luego, en una nueva l√≠nea, da una explicaci√≥n muy breve y simple del porqu√©, sin revelar la soluci√≥n completa si es incorrecta.`;
                    
                    try {
                        const result = await callGemini(checkPrompt);
                        if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                            const text = result.candidates[0].content.parts[0].text;
                            if (text.toLowerCase().startsWith('correcto')) {
                                resultContainer.innerHTML = `<p class="text-green-600 font-bold">¬°Correcto! üéâ</p><p class="text-sm mt-1">${text.substring(text.indexOf('.') + 1).trim()}</p>`;
                            } else {
                                resultContainer.innerHTML = `<p class="text-red-600 font-bold">Incorrecto.</p><p class="text-sm mt-1">${text.substring(text.indexOf('.') + 1).trim()}</p>`;
                            }
                        } else {
                            resultContainer.innerHTML = `<p class="text-red-500">No se pudo verificar la respuesta.</p>`;
                        }
                    } catch (error) {
                        handleApiError(error, resultContainer);
                    } finally {
                        btn.disabled = false;
                    }
                });
            });

            document.querySelectorAll('.gemini-solve-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const btn = event.currentTarget;
                    const solveResultContainer = btn.nextElementSibling;
                    const problem = btn.closest('.content-section').querySelector('.gemini-result-container').dataset.problem;
                    const methodName = btn.closest('.content-section').dataset.methodName;

                    solveResultContainer.classList.toggle('hidden');
                    
                    if (!solveResultContainer.classList.contains('hidden') && solveResultContainer.innerHTML.trim() === '') {
                        solveResultContainer.innerHTML = '<div class="loader"></div>';
                        btn.disabled = true;

                        const solvePrompt = `Resuelve la siguiente ecuaci√≥n diferencial de primer orden paso a paso, explicando cada parte del proceso. La ecuaci√≥n es: ${problem}. El m√©todo a usar es el de Ecuaciones ${methodName}. Formatea la soluci√≥n con encabezados claros para cada paso y usa delimitadores de $$ para todas las expresiones matem√°ticas.`;
                        
                        try {
                            const result = await callGemini(solvePrompt);
                            if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                                solveResultContainer.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                                renderMath(solveResultContainer);
                            } else {
                                 solveResultContainer.innerHTML = `<p class="text-red-500">No se pudo generar la soluci√≥n.</p>`;
                            }
                        } catch (error) {
                            handleApiError(error, solveResultContainer);
                        } finally {
                            btn.disabled = false;
                        }
                    }
                });
            });

            // --- Event Listener for Custom Solver ---
            document.getElementById('analyze-custom-eq-btn').addEventListener('click', async () => {
                const btn = document.getElementById('analyze-custom-eq-btn');
                const equation = document.getElementById('custom-eq-input').value.trim();
                const recommendationContainer = document.getElementById('custom-eq-recommendation-container');
                const solverBlock = document.getElementById('custom-solver-block');

                if (!equation) {
                    recommendationContainer.innerHTML = `<p class="text-orange-600 font-semibold">Por favor, introduce una ecuaci√≥n.</p>`;
                    return;
                }

                recommendationContainer.innerHTML = '<div class="loader"></div>';
                solverBlock.classList.add('hidden');
                btn.disabled = true;

                const methodList = Object.values(contentData).map(m => m.name).join(', ');
                const prompt = `Analiza la ecuaci√≥n diferencial de primer orden: "${equation}". Identifica el m√©todo m√°s eficiente para resolverla de la siguiente lista: ${methodList}. En la primera l√≠nea, escribe solo el nombre del m√©todo recomendado (ej: "Variables Separables"). En una nueva l√≠nea, escribe una explicaci√≥n concisa del porqu√©.`;

                try {
                    const result = await callGemini(prompt);
                    if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text.trim();
                        const lines = text.split('\n');
                        const recommendedMethod = lines[0].trim();
                        const reason = lines.slice(1).join(' ').trim();
                        
                        recommendationContainer.innerHTML = `
                            <p><span class="font-bold">M√©todo Recomendado:</span> <span class="text-teal-700 font-semibold">${recommendedMethod}</span></p>
                            <p class="mt-2"><span class="font-bold">Raz√≥n:</span> ${reason}</p>
                        `;

                        // Pre-select the recommended method in the dropdown
                        const select = document.getElementById('custom-method-select');
                        const optionToSelect = Array.from(select.options).find(opt => recommendedMethod.includes(opt.text));
                        if(optionToSelect) {
                            select.value = optionToSelect.value;
                        }

                        solverBlock.classList.remove('hidden');

                    } else {
                        recommendationContainer.innerHTML = `<p class="text-red-500">No se pudo analizar la ecuaci√≥n.</p>`;
                    }
                } catch(error) {
                    handleApiError(error, recommendationContainer);
                } finally {
                    btn.disabled = false;
                }
            });

            document.getElementById('solve-custom-eq-btn').addEventListener('click', async () => {
                 const btn = document.getElementById('solve-custom-eq-btn');
                const equation = document.getElementById('custom-eq-input').value.trim();
                const method = document.getElementById('custom-method-select').value;
                const resultContainer = document.getElementById('custom-eq-result-container');

                resultContainer.innerHTML = '<div class="loader"></div>';
                btn.disabled = true;

                const prompt = `Resuelve la siguiente ecuaci√≥n diferencial: "${equation}" utilizando el m√©todo de Ecuaciones ${method}. Muestra todos los pasos de manera clara, explicando el procedimiento. Formatea la respuesta con encabezados para cada paso y usa delimitadores de $$ para todas las expresiones matem√°ticas.`;
                
                try {
                    const result = await callGemini(prompt);
                    if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        resultContainer.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                        renderMath(resultContainer);
                    } else {
                        resultContainer.innerHTML = `<p class="text-red-500">No se pudo resolver la ecuaci√≥n. Verifica que est√© bien escrita o prueba con otro m√©todo.</p>`;
                    }
                } catch(error) {
                    handleApiError(error, resultContainer);
                } finally {
                    btn.disabled = false;
                }
            });
            
            // --- Event Listener for Applications Finder ---
            document.getElementById('gemini-app-btn').addEventListener('click', async () => {
                const btn = document.getElementById('gemini-app-btn');
                const query = document.getElementById('app-query-input').value.trim();
                if (!query) {
                    alert("Por favor, introduce un campo de estudio.");
                    return;
                }
                
                const resultContainer = document.getElementById('gemini-app-result-container');
                resultContainer.innerHTML = '<div class="loader"></div>';
                btn.disabled = true;
                
                const prompt = `Busca y explica brevemente una aplicaci√≥n del mundo real de las ecuaciones diferenciales de primer orden en el campo de "${query}". Describe el escenario, la ecuaci√≥n que lo modela y qu√© representa.`;
                
                try {
                    const result = await callGemini(prompt, true);
                    if (result && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        let html = `<p>${result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>')}</p>`;
                        
                        const groundingMetadata = result.candidates[0]?.groundingMetadata;
                        if (groundingMetadata?.groundingAttributions?.length > 0) {
                            html += `<h4 class="font-semibold mt-4 mb-2">Fuentes:</h4><ul class="list-disc list-inside text-sm">`;
                            groundingMetadata.groundingAttributions.forEach(attr => {
                                if (attr.web?.uri) {
                                    html += `<li><a href="${attr.web.uri}" target="_blank" class="text-teal-600 hover:underline">${attr.web.title || attr.web.uri}</a></li>`;
                                }
                            });
                            html += `</ul>`;
                        }
                        resultContainer.innerHTML = html;
                        renderMath(resultContainer);
                    } else {
                        resultContainer.innerHTML = `<p class="text-red-500">No se pudo encontrar una aplicaci√≥n. Intenta con otro t√©rmino.</p>`;
                    }
                } catch(error) {
                    handleApiError(error, resultContainer);
                } finally {
                    btn.disabled = false;
                }
            });

            mainApp();
    });
    </script>
</body>
</html>

